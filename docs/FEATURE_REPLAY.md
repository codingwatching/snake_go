# Snake Game Replay System Design

## 1. Overview

The Replay System is a dedicated component of the snake_go project designed to visualize game sessions. It parses `.jsonl` recording files generated by the game server and streams them to a web client, allowing developers and researchers to analyze gameplay, debug AI behavior, and verify reinforcement learning data.

## 2. Architecture

### 2.1 Component Diagram

```mermaid
graph TD
    A[Game Server] -->| writes | B(File System /records)
    B -->| reads | C[Replay Server :8081]
    C -->| streams | D[Web Frontend]
    D -->| imports | E[Game Engine (game.js)]
```

### 2.2 Data Flow

1.  **Recording**: The Game Server (`cmd/webserver`) creates a new `.jsonl` file for each game session. Every tick, it appends a `StepRecord` JSON object containing the full State, Action, AI Context, and Reward.
2.  **Serving**: The Replay Server (`cmd/replay`) scans the `records/` directory and serves a list of available files at root `/`.
3.  **Streaming**: When a file is selected, the server establishes a WebSocket connection (`/ws/replay?file=...`).
4.  **Playback**: The server reads the file line-by-line and sends messages to the client:
    *   **Config**: The first message contains grid size and settings.
    *   **State**: Subsequent messages contain the game state snapshot.
5.  **Rendering**: The frontend (`replay.html` + `replay.js`) instantiates a modified `SnakeGameClient` that:
    *   Disables keyboard input logging.
    *   Receives state from WebSocket instead of calculating it locally.
    *   Uses the shared `GameRenderer` to draw the frame.

## 3. File Format (.jsonl)

The recording format is **JSON Lines**. Each line is a valid JSON object representing one simulation step.

```json
/* Line 1: Initial Step */
{
  "step_id": 0,
  "ts": 1673859000000,
  "state": { "snake": [...], "score": 0, ... },
  "action": { "dir": {"x":0,"y":1}, "fire": false },
  "reward": 0.1,
  "done": false
}
...
/* Line N: Game Over */
{
  "step_id": 100,
  "ts": 1673859005000,
  "state": { "gameOver": true, ... },
  "reward": -100,
  "done": true
}
```

## 4. Key Features

*   **Zero-Overhead Recording**: Writing is handled asynchronously in Go to avoid blocking the main game loop.
*   **Frontend Reusability**: The Replay Viewer reuses 95% of the main game's JavaScript (`game.js`), ensuring that what you see in the replay is pixel-perfectly identical to what the player saw.
*   **Standalone Binary**: The replay tool `cmd/replay` is a separate binary, keeping the main game server lean.

## 5. Usage

### Build
```bash
go build -o replay ./cmd/replay
```

### Run
```bash
./replay
```
Visit `http://localhost:8081` to browse recordings.

## 6. Future Improvements

*   **Seek Bar**: Allow jumping to specific tick numbers.
*   **Playback Speed**: 0.5x, 2x, 4x speed controls.
*   **Heatmaps**: Overlay death locations or movement frequency on the board.
